<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tms.easyrento.dbMappers.PropertyMapper">


    <resultMap id="propertyMap" type="com.tms.easyrento.dto.response.PropertyResponse" autoMapping="true">
        <id property="id" column="id"/>
        <collection property="images" ofType="java.lang.String" javaType="list">
            <result column="fileName"/>
        </collection>
    </resultMap>

    <resultMap id="propertyList" type="com.tms.easyrento.dto.response.PropertyResponse" autoMapping="true">
        <id property="id" column="propertyId"/>
        <!-- Define the collection mapping for property images -->
        <collection property="images" ofType="java.lang.String" javaType="list">
            <result column="propertyImage_fileName"/>
        </collection>
    </resultMap>

    <resultMap id="singlePropertyInfo" type="com.tms.easyrento.dto.response.SinglePropertyResponse" autoMapping="true" >
        <id property="id" column="propertyId"/>
        <association property="featuredImage" resultMap="imageMap" columnPrefix="propertyImage_"/>
        <collection property="secondaryImages" ofType="com.tms.easyrento.dto.response.ImageResponse" autoMapping="true"
                    columnPrefix="propertyImage_" >
            <id property="id" column="id" />
            <id property="featured" column="featured" javaType="boolean"/>
            <id property="imageType" column="imageType" />
        </collection>
    </resultMap>

    <resultMap id="imageMap" type="com.tms.easyrento.dto.response.ImageResponse" autoMapping="true">
        <id property="id" column="id" />
        <id property="featured" column="featured" javaType="boolean"/>
    </resultMap>


    <select id="findSinglePropertyByOwnerId" resultMap="propertyMap">
        select p.id as id,
        p.property_code as propertyCode,
        p.title as propertyTitle,
        p.property_type as propertyType,
        p.allocated_price as allocatedPrice,
        p.price_per_unit as pricePerUnit,
        p.is_system_evaluated_price as isSystemEvaluatedPrice,
        p.occupied as occupied,
        p.dynamic_price as dynamicPrice,
        p.total_rooms as totalRooms,

        p_i.file_name as fileName

        from properties p
        inner join property_images p_i on p.id = p_i.property_id
        where p.owner_id = #{ownerId} and p.id = #{propertyId}

    </select>
    <select id="findActiveList" resultMap="propertyList">
        SELECT
        p.id as propertyId,
        p.property_code as propertyCode,
        p.title as propertyTitle,
        p.property_type as propertyType,
        p.allocated_price as propertyPrice,
        p.price_per_unit as pricePerUnit,
        p.is_system_evaluated_price as isSystemEvaluatedPrice,
        p.dynamic_price as dynamicPrice,
        p.total_rooms as totalRooms,
        p.occupied as occupied,


        p_i.id as propertyImage_id,
        p_i.file_name as propertyImage_fileName

        FROM properties p
        inner join property_images p_i on p.id = p_i.property_id
        WHERE CASE
        WHEN #{isActive} = '1' THEN p.active = true
        WHEN #{isActive} = '0' THEN p.active = false
        ELSE p.active = p.active
        END
    </select>
    <select id="findPropertiesByOwnerId" resultMap="propertyList">
        SELECT
        p.id as propertyId,
        p.property_code as propertyCode,
        p.title as propertyTitle,
        p.property_type as propertyType,
        p.allocated_price as allocatedPrice,
        p.price_per_unit as pricePerUnit,
        p.is_system_evaluated_price as isSystemEvaluatedPrice,
        p.dynamic_price as dynamicPrice,
        p.total_rooms as totalRooms,
        p.occupied as occupied,
        p.created_on as createdOn,

        p_i.id as propertyImage_id,
        p_i.file_name as propertyImage_fileName

        FROM properties p
        inner join property_images p_i on p.id = p_i.property_id
        where p.owner_id = #{ownerId}
    </select>

    <select id="getSinglePropertyForAdmin" resultMap="singlePropertyInfo">
        SELECT
        p.id                        as propertyId,
        p.property_code             as propertyCode,
        p.title                     as propertyTitle,
        p.property_type             as propertyType,
        p.allocated_price           as propertyPrice,
        p.price_per_unit            as pricePerUnit,
        p.is_system_evaluated_price as isSystemEvaluatedPrice,
        p.dynamic_price             as dynamicPrice,
        p.total_rooms               as totalRooms,
        p.occupied                  as occupied,

        p_i.id                      as propertyImage_id,
        p_i.file_name               as propertyImage_fileName,
        p_i.featured                as propertyImage_featured,
        p.title                     as propertyImage_altText,
        case when p_i.featured
             then 'featured'
             else 'secondary'
        end                         as propertyImage_imageType

        FROM properties p
        inner join property_images p_i on p.id = p_i.property_id
        WHERE p.id = #{propertyId}
    </select>

</mapper>